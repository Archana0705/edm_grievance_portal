<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Citizen behalf Raise Ticket</title>
  <!-- Bootstrap CSS -->

  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/font/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/aos.css" rel="stylesheet">

  <style>
    body {
      background: #f9fafb;
    }

    .card {
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .step-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #444;
    }

    .btn-primary {
      border-radius: 30px;
      padding: 10px 25px;
    }

    .hidden {
      display: none;
    }

    .success-check {
      font-size: 3rem;
      color: green;
      display: none;
      animation: bounceIn 1s forwards;
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }

      50% {
        transform: scale(1.1);
        opacity: 1;
      }

      100% {
        transform: scale(1);
      }
    }
  </style>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f1f3f6;
      color: #333;
    }

    body {
      display: flex;
      flex-direction: column;
      padding-top: 70px;
      transition: all 0.3s;
    }

    /* Header */
    nav.navbar {
      background: linear-gradient(90deg, #4b6cb7, #182848);
      color: #fff;
      z-index: 1000;
      padding: 0.4rem 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    nav.navbar .navbar-brand,
    nav.navbar .btn,
    nav.navbar span {
      color: #fff;
    }

    nav.navbar .btn-light {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: #fff;
    }

    nav.navbar .btn-light:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      width: 220px;
      height: calc(100% - 70px);
      background: #fff;
      padding-top: 1rem;
      transition: all 0.3s;
      overflow-y: auto;
      border-right: 1px solid #e0e0e0;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
      z-index: 999;
    }

    #sidebar a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #495057;
      text-decoration: none;
      font-weight: 500;
      border-radius: 8px;
      margin: 4px 10px;
      transition: all 0.2s ease-in-out;
    }

    #sidebar a:hover {
      background: #4b6cb7;
      color: #fff;
      transform: translateX(5px);
    }

    #sidebar a.active {
      background: #182848;
      color: white;
    }

    #sidebar i {
      margin-right: 12px;
      font-size: 1.2rem;
    }

    .sidebar-collapsed #sidebar a {
      padding: 12px 0px;
    }

    /* Collapsed sidebar */
    body.sidebar-collapsed #sidebar {
      width: 60px;
    }

    body.sidebar-collapsed #sidebar a span {
      display: none;
    }

    body.sidebar-collapsed #sidebar a i {
      margin-right: 0;
      width: 100%;
      text-align: center;
    }

    /* Main content */
    #mainContent {
      margin-left: 220px;
      padding: 30px;
      flex: 1;
      transition: all 0.3s;
    }

    body.sidebar-collapsed #mainContent {
      margin-left: 60px;
    }

    /* Cards for main content */
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* Footer */
    footer {
      background: #fff;
      text-align: center;
      padding: 15px;
      border-top: 1px solid #ddd;
      width: 100%;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Mobile responsiveness */
    @media (max-width: 992px) {
      #sidebar {
        left: -100%;
        top: 0;
        width: 220px;
        height: 100%;
        border-right: none;
        box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
        z-index: 9999;
      }

      #sidebar.show {
        left: 0;
      }

      #mainContent {
        margin-left: 0;
        padding: 20px 10px;
      }

      body.sidebar-collapsed #mainContent {
        margin-left: 0;
      }
    }

    @media (max-width: 768px) {
      #currentDateTime {
        display: none;
      }

      .navbar .fw-bold {
        font-size: 1.1rem;
      }

      #sidebarToggle {
        padding: 0.35rem 0.6rem;
      }

      .dropdown-toggle span {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid d-flex align-items-center">
      <button class="btn btn-light" id="sidebarToggle">
        <i class="bi bi-list fs-4"></i>
      </button>
      <span class="fw-bold ms-3 fs-5">Operator Dashboard</span>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span id="currentDateTime" class="me-3"></span>
        <div class="dropdown">
          <button class="btn btn-light dropdown-toggle" id="profileDropdown" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle fs-4"></i> <span class="d-none d-lg-inline fw-semibold">John</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
            <li><a class="dropdown-item" href="profile.html">Profile</a></li>
            <li><a class="dropdown-item" href="index.html">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>
  <!-- Sidebar -->
  <div id="sidebar">
    <a href="dashboard.html"><i class="bi bi-house"></i><span>Dashboard</span></a>
    <a href="report-issue-ajax.html"><i class="bi bi-file-earmark-text"></i><span>Report Issue - Self</span></a>
    <a href="raise-ticket-behalf.html" class="active"><i class="bi bi-eye"></i><span>Report Issue - Behalf</span></a>
    <a href="profile.html"><i class="bi bi-person"></i><span>Profile</span></a>
    <a href="faq.html"><i class="bi bi-question-circle"></i><span>FAQ</span></a>
  </div>
  <!-- Main Content -->
  <div id="mainContent">

    <div class="container">
      <div class="card p-4" data-aos="fade-up">
        <!-- Step 1: Mobile OTP Verification -->
        <div id="step1">
          <h4 class="step-title mb-3">Citizen Verification - Behalf</h4>
          <div class="row">
            <div class="mb-3 col-lg-4">
              <label class="form-label">Relationship Type</label>
              <select id="genderField" class="form-select mb-2">
                <option selected="">Select Relationship Type</option>
                <option>Sister</option>
                <option>Friend</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-3 col-md-4">
              <label class="form-label">Mobile Number</label>
              <input type="text" class="form-control" id="citizenMobile" placeholder="Enter mobile number">
            </div>
            <div class="mb-3 col-md-4 d-flex align-items-center">
              <button class="btn btn-primary mt-4" id="sendOtpBtn">Send OTP</button>
            </div>
          </div>

          <div id="otpSection" class="hidden mt-3 col-md-4">
            <label class="form-label">Enter OTP</label>
            <input type="text" class="form-control" id="citizenOtp" placeholder="Enter 6-digit OTP">
            <button class="btn btn-success mt-2" id="verifyOtpBtn">Verify OTP</button>
            <p id="otpTimer" class="text-muted small mt-2"></p>
          </div>
          <div class="success-check text-center mt-3" id="otpSuccess">✔</div>
        </div>

        <!-- Step 2: Ticket Form -->
        <div id="step2" class="hidden mt-4">
          <!-- <h4 class="step-title mb-3">Raise Ticket (On Behalf of Citizen)</h4> -->


          <h2 class="page-title mb-2"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i> Report an Issue
            (On Behalf of Citizen)</h2>
          <div class="form-section">
            <!-- Main Form -->
            <form id="issueForm" class="needs-validation" novalidate>
              <div class="row g-3">

                <!-- Citizen Details -->
                <div class="mb-3 col-lg-4">
                  <label class="form-label">Citizen Name</label>
                  <input type="text" class="form-control" placeholder="Enter Citizen Name">
                </div>
                <div class="mb-3 col-lg-4">
                  <label class="form-label">Mobile</label>
                  <input type="text" class="form-control" value="(Verified Mobile)" readonly>
                </div>
                <div class="mb-3 col-lg-4">
                  <label class="form-label">Gender</label>
                  <select id="genderField" class="form-select mb-2">
                    <option selected="">Select Gender</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                  </select>
                </div>
                <div class="mb-3 col-lg-4">
                  <label class="form-label">District</label>
                  <select id="districtField" class="form-select mb-2">
                    <option selected="">Select District</option>
                    <option>Coimbatore</option>
                    <option>Madurai</option>
                  </select>
                </div>
                <div class="mb-3 col-lg-4">
                  <label class="form-label">Email</label>
                  <input type="email" id="emailField" class="form-control mb-3" placeholder="Enter your Email">
                </div>

                <div class="clear-both"></div>

                <div class="mb-3 col-lg-4">
                  <label>Type</label>
                  <select id="typeSelect" class="form-control">
                    <option value="">Select Type</option>
                  </select>
                </div>
                <div class="mb-3 col-lg-4">
                  <label>Category</label>
                  <select id="categorySelect" class="form-control">
                    <option value="">Select Category</option>
                  </select>
                </div>
                <div class="mb-3 col-lg-4">
                  <label>Sub-Category</label>
                  <select id="subCategorySelect" class="form-control">
                    <option value="">Select Sub-Category</option>
                  </select>
                </div>

              </div>
              <!-- Dynamic Form -->
              <div id="dynamicFieldsContainer" class="mt-4"></div>


              <!-- Declaration Component -->
              <div class="alert alert-light border rounded-3 shadow-sm p-3 mb-4" role="alert">
                <div class="d-flex align-items-start">
                  <i class="bi bi-info-circle-fill text-primary fs-4 me-3"></i>
                  <div>
                    <h6 class="fw-bold mb-2">Declaration</h6>
                    <p class="mb-2 small text-muted">
                      I hereby declare that the information provided in this portal is true and correct
                      to the best of my knowledge. Any false information may lead to rejection of the grievance.
                    </p>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="declarationCheck">
                      <label class="form-check-label small" for="declarationCheck">
                        I agree to the terms of this declaration
                      </label>
                    </div>
                    <span class="text-danger small" id="declarationError" style="display:none;"></span>

                  </div>
                </div>
              </div>


              <!-- Submit -->
              <div class="col-lg-4 d-flex align-items-center">
                <button type="submit" id="submitBtn" class="btn btn-primary px-4 py-2">
                  <i class="bi bi-send-fill me-2"></i> Submit Issue
                </button>
              </div>
            </form>


          </div>
        </div>
      </div>


    </div>
  </div>
  <!-- Footer -->
  <footer>
    &copy; 2025 My Dashboard. All rights reserved.
  </footer>
  <div class="toast-container">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-check-circle-fill me-2"></i> Issue submitted successfully!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS -->

  <script src="assets/js/jquery-3.7.1.min.js"></script>
  <!-- <script src="assets/js/bootstrap.bundle.min.js"></script> -->
  <script src="assets/js/aos.js"></script>
  <script src="assets/js/dataTableUtil.js"></script>
  <script src="assets/js/crypto-js.min.js"></script>
  <script src="assets/js/global.js"></script>
  <script src="assets/js/encrypt_decrypt.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/toastUtil.js"></script>
  <script src="assets/js/apiConfig.js"></script>
  <script src="assets/js/globalProfileDropdown.js"></script>
  <script>
    // Sidebar toggle
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');

    sidebarToggle.addEventListener('click', () => {
      if (window.innerWidth < 992) {
        // Mobile: slide in/out
        sidebar.classList.toggle('show');
      } else {
        // Desktop: collapse sidebar
        document.body.classList.toggle('sidebar-collapsed');
      }
    });

    // Close mobile sidebar when clicking outside
    document.addEventListener('click', function (e) {
      if (window.innerWidth < 992) {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
          sidebar.classList.remove('show');
        }
      }
    });

    // Display current date and time
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      document.getElementById('currentDateTime').textContent = now.toLocaleDateString(undefined, options) + ' ' + timeString;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();
  </script>
  <script>
    AOS.init();

    // OTP flow simulation
    let otpTimer;
    $('#sendOtpBtn').click(function () {
      $('#otpSection').removeClass('hidden');
      let timeLeft = 120; // 2 min timer
      $('#otpTimer').text("OTP sent. Expires in 120s");
      otpTimer = setInterval(function () {
        timeLeft--;
        $('#otpTimer').text("OTP sent. Expires in " + timeLeft + "s");
        if (timeLeft <= 0) { clearInterval(otpTimer); $('#otpTimer').text("OTP expired. Please resend."); }
      }, 1000);
    });

    $('#verifyOtpBtn').click(function () {
      let otp = $('#citizenOtp').val();
      if (otp === "") { // demo OTP
        clearInterval(otpTimer);
        $('#otpSuccess').fadeIn();
        setTimeout(function () {
          $('#step1').hide();
          $('#step2').removeClass('hidden').hide().fadeIn();
        }, 1000);
      } else {
        alert("Invalid OTP. Try again.");
      }
    });
  </script>

  <script>

    const maxFiles = 3;

    function updateFileRowButtons() {
      const $rows = $(".file-group-wrapper .file-group");
      const total = $rows.length;

      $rows.each(function (index) {
        const $row = $(this);
        const $btnCol = $row.find(".col-md-3");
        $btnCol.empty();

        if (index === 0 && total === 1) {
          $btnCol.append(`
          <button type="button" class="btn btn-outline-primary add-file-row w-100">
            <i class="bi bi-plus-circle"></i> Add
          </button>
        `);
        } else if (index === total - 1 && total < maxFiles) {
          $btnCol.append(`
          <div class="d-flex w-100 gap-2">
            <button type="button" class="btn btn-outline-primary add-file-row flex-fill">
              <i class="bi bi-plus-circle"></i> Add
            </button>
            <button type="button" class="btn btn-outline-danger remove-file-row flex-fill">
              <i class="bi bi-dash-circle"></i> Remove
            </button>
          </div>
        `);
        } else if (index === total - 1 && total === maxFiles) {
          $btnCol.append(`
          <button type="button" class="btn btn-outline-danger remove-file-row w-100">
            <i class="bi bi-dash-circle"></i> Remove
          </button>
        `);
        } else {
          $btnCol.append(`
          <div class="d-flex w-100 gap-2">
            <button type="button" class="btn btn-outline-primary add-file-row flex-fill">
              <i class="bi bi-plus-circle"></i> Add
            </button>
            <button type="button" class="btn btn-outline-danger remove-file-row flex-fill">
              <i class="bi bi-dash-circle"></i> Remove
            </button>
          </div>
        `);
        }
      });
    }

    $(document).on("click", ".add-file-row", function () {
      const total = $(".file-group-wrapper .file-group").length;
      if (total < maxFiles) {
        const newRow = `
        <div class="row g-2 align-items-end file-group mb-2">
          <div class="col-md-5">
            <label class="form-label fw-semibold">Attach Supporting Documents *</label>
            <input type="file" class="form-control" required multiple>
            <small class="text-danger">* Max. file size allowed is 1 MB</small>
          </div>
          <div class="col-md-3"></div>
        </div>`;
        $(".file-group-wrapper").append(newRow);
        updateFileRowButtons();
      }
    });

    $(document).on("click", ".remove-file-row", function () {
      $(this).closest(".file-group").remove();
      updateFileRowButtons();
    });

    // ---------------- API CALLS ----------------
    $(document).ready(function () {
      const roleId = localStorage.getItem("role_id");

      // Type dropdown
      const payload = {
        action: "function_call",
        function_name: "fn_issue_type",
        params: {}
      };

      $.ajax({
        url: `${BASE_API_URL}/commonfunction`,
        method: "POST",
        data: { data: encryptData(payload) },
        dataType: "json",
        success(response) {
          const decrypted = decryptData(response.data);
          const $dropdown = $("#typeSelect");
          $dropdown.empty().append('<option value="" class="placeholder">--Select Type--</option>');

          decrypted.forEach(item => {
            $dropdown.append(`<option value="${item.id}">${item.issue_name}</option>`);
          });
        }
      });

      // Category dropdown
      $('#typeSelect').on('change', function () {
        const selectedType = $(this).val();
        const operatorPayload = {
          action: "function_call",
          function_name: "fn_issue_category",
          params: { type: selectedType || '', roleid: roleId }
        };

        $.ajax({
          url: `${BASE_API_URL}/commonfunction`,
          method: 'POST',
          data: { data: encryptData(operatorPayload) },
          dataType: 'json',
          success(response) {
            const decrypted = decryptData(response.data);
            const $dropdown = $('#categorySelect');
            $dropdown.empty().append('<option value="" class="placeholder">--Select Category--</option>');

            decrypted.forEach(item => {
              $dropdown.append(`<option value="${item.id}">${item.issue_name}</option>`);
            });
          }
        });
      });

      // Sub Category dropdown + field builder
      $('#categorySelect').on('change', function () {
        const selectedCategory = $(this).val();
        const operatorPayload = {
          action: "function_call",
          function_name: "fn_issue_subcategory",
          params: { type: selectedCategory || '', roleid: roleId }
        };

        $.ajax({
          url: `${BASE_API_URL}/commonfunction`,
          method: 'POST',
          data: { data: encryptData(operatorPayload) },
          dataType: 'json',
          success(response) {
            const decrypted = decryptData(response.data);
            const $dropdown = $('#subCategorySelect');
            $dropdown.empty().append('<option value="" class="placeholder">--Select Sub Category--</option>');

            decrypted.forEach(item => {
              $dropdown.append(`<option value="${item.id}" data-columns="${item.relavant_columns || ''}">${item.issue_name}</option>`);
            });

            // Clear dynamic fields initially
            $('#dynamicFieldsContainer').empty();
          }
        });
      });


      const fieldMap = {
        "1man": { label: "CAN Number (mandatory)", type: "text", required: true },
        "1opt": { label: "CAN Number (optional)", type: "text", required: false },
        "2man": { label: "Application number (mandatory)", type: "text", required: true },
        "2opt": { label: "Application number (optional)", type: "text", required: false },
        "3man": { label: "Description of changes and reason (mandatory)", type: "textarea", required: true },
        "3opt": { label: "Description of the issue (Optional)", type: "textarea", required: false },
        "4man": { label: "Multiple Attach supporting document (mandatory)", type: "file", required: true, multiple: true },
        "4opt": { label: "Multiple Attach supporting document (optional)", type: "file", required: false, multiple: true },
        "5man": { label: "Supporting document description (mandatory, short text)", type: "textarea", required: true },
        "5opt": { label: "Multiple Supporting document description (optional, short text)", type: "textarea", required: false },
        "6man": { label: "Enter eSevai log in ID (mandatory)", type: "text", required: true },
        "7man": { label: "Enter eSevai centre ID against whom the grievance is lodged (mandatory)", type: "text", required: true },
        "8man": { label: "Transaction number (mandatory)", type: "text", required: true },
        "9man": { label: "Enter reason for ID block (mandatory)", type: "textarea", required: true },
        "10opt": { label: "Enter name of official (optional)", type: "text", required: false }
      };


      $('#subCategorySelect').on('change', function () {
        const selectedOption = $(this).find('option:selected');
        const columnsData = selectedOption.attr('data-columns'); // e.g., "3man,4opt,7man"
        generateDynamicFields(columnsData);
      });


      function generateDynamicFields(columnsString) {
        const $container = $('#dynamicFieldsContainer');
        $container.empty();

        if (!columnsString) {
          $container.append('<p>No additional fields required for this subcategory.</p>');
          return;
        }

        const columnsArray = columnsString.split(',');

        columnsArray.forEach((col, index) => {
          col = col.trim();
          const field = fieldMap[col];
          if (!field) return;

          const inputId = `field_${col}_${index}`;
          const isMandatory = col.endsWith('man');
          const mandatoryAttr = isMandatory ? 'data-mandatory="true"' : '';
          const nameAttr = `name="${field.paramName}"`;
          const dataColAttr = `data-col="${col}"`;

          // Handle multiple file attachments (optional)
          if (col === "4opt") {
            const wrapperId = `wrapper_${inputId}`;
            const html = `
                <div id="${wrapperId}" class="mb-3 file-wrapper">
                    <label>${field.label}</label>
                    <div class="file-row d-flex align-items-center mb-2">
                        <input type="file" class="form-control me-2 file-input">
                        <button type="button" class="btn btn-danger btn-sm btn-delete-file">Delete</button>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm btn-add-file">Add More</button>
                </div>
            `;
            $container.append(html);
          } else {
            let fieldHtml = '';
            if (field.type === "textarea") {
              fieldHtml = `
                    <div class="mb-3">
                        <label for="${inputId}">${field.label}</label>
                        <textarea id="${inputId}" class="form-control" ${nameAttr} ${dataColAttr} ${mandatoryAttr}></textarea>
                    </div>`;
            } else {
              fieldHtml = `
                    <div class="mb-3">
                        <label for="${inputId}">${field.label}</label>
                        <input id="${inputId}" type="${field.type}" class="form-control" ${nameAttr} ${dataColAttr} ${mandatoryAttr}>
                    </div>`;
            }
            $container.append(fieldHtml);
          }
        });
      }

      $(document).on('click', '.btn-add-file', function () {
        const $wrapper = $(this).closest('.file-wrapper');
        const currentCount = $wrapper.find('.file-row').length;

        if (currentCount >= 3) {
          alert("You can only add up to 3 attachments.");
          return;
        }

        const $newRow = $(`
        <div class="file-row d-flex align-items-center mb-2">
            <input type="file" class="form-control me-2 file-input">
            <button type="button" class="btn btn-danger btn-sm btn-delete-file">Delete</button>
        </div>
    `);
        $(this).before($newRow);
      });

      $(document).on('click', '.btn-delete-file', function () {
        $(this).closest('.file-row').remove();
      });


      $(document).on('input', '#dynamicFieldsContainer input[type="text"], #dynamicFieldsContainer textarea, #dynamicFieldsContainer select', function () {
        const $this = $(this);
        if ($this.data('mandatory') && $this.val().trim() === '') {
          $this.addClass('is-invalid');
          $this.next('.error-msg').remove();
          $this.after('<span class="error-msg text-danger">This field is required</span>');
        } else {
          $this.removeClass('is-invalid');
          $this.next('.error-msg').remove();
        }
      });

      $(document).on('input change', '#dynamicFieldsContainer input, #dynamicFieldsContainer textarea, #dynamicFieldsContainer select', function () {
        if ($(this).val().trim() !== '') {
          $(this).removeClass('is-invalid');
          $(this).next('.error-msg').remove();
        }
      });

      // 2. Mandatory selects outside dynamic fields
      $('#typeSelect, #categorySelect, #subCategorySelect').on('change', function () {
        if ($(this).val() && $(this).val().trim() !== '') {
          $(this).removeClass('is-invalid');
          $(this).next('.error-msg').remove();
        }
      });

      function safeVal(val) {
        if (val === undefined || val === null) return null;
        if (typeof val === "string" && val.trim() === "") return null;
        return val;
      }

      async function processFiles() {
        const filesArray = [];

        $('#dynamicFieldsContainer input[type="file"]').each(function () {
          const files = this.files;
          const desc = $(this).closest('.file-group').find('.file-desc').val() || '';

          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            filesArray.push({
              file_name: file.name,
              file_path: `/uploads/${file.name}`, // ⚡ adjust if backend returns actual path
              mime_type: file.type,
              attachment_desc: desc
            });
          }
        });

        return filesArray;
      }



      // $('#submitBtn').on('click', async function (event) {
      //   event.preventDefault();

      //   let isValid = true;

      //   if (!$('#declarationCheck').is(':checked')) {
      //     $('#declarationError').text('You must agree to the declaration.').show();
      //     isValid = false;
      //   } else {
      //     $('#declarationError').hide();
      //   }

      //   $('#declarationCheck').on('change', function () {
      //     if ($(this).is(':checked')) {
      //       $('#declarationError').hide();
      //     }
      //   });


      //   // Validate type, category, subcategory
      //   ['#typeSelect', '#categorySelect', '#subCategorySelect'].forEach(selector => {
      //     const $el = $(selector);
      //     if (!$el.val() || $el.val().trim() === '') {
      //       $el.addClass('is-invalid');
      //       $el.next('.error-msg').remove();
      //       $el.after('<span class="error-msg text-danger">This field is required</span>');
      //       isValid = false;
      //     } else {
      //       $el.removeClass('is-invalid');
      //       $el.next('.error-msg').remove();
      //     }
      //   });

      //   $('#dynamicFieldsContainer [data-mandatory="true"]').each(function () {
      //     if ($(this).val().trim() === '') {
      //       $(this).addClass('is-invalid');
      //       $(this).next('.error-msg').remove();
      //       $(this).after('<span class="error-msg text-danger">This field is required</span>');
      //       isValid = false;
      //     } else {
      //       $(this).removeClass('is-invalid');
      //       $(this).next('.error-msg').remove();
      //     }
      //   });

      //   if (!isValid) {
      //     showErrorToast('Please fill in all mandatory fields.');
      //     return;
      //   }




      //   try {
      //     // Collect uploaded files
      //     const uploadedFiles = await processFiles();

      //     // Get relevant columns for selected subcategory
      //     const selectedOption = $('#subCategorySelect').find('option:selected');
      //     const columnsData = selectedOption.attr('data-columns'); // e.g., "3man,4opt,7man"
      //     const columnsArray = columnsData ? columnsData.split(',').map(c => c.trim()) : [];

      //     // All possible fields with default null
      //     const allParams = {
      //       p_complainant_name: null,
      //       p_mobile: null,
      //       p_email: null,
      //       p_district_id: null,
      //       p_issue_id: null,
      //       p_created_by_user_id: null,
      //       p_category_id: null,
      //       p_subcategory_id: null,
      //       p_priority: null,
      //       p_onbehalf_name: null,
      //       p_onbehalf_mobile: null,
      //       p_onbehalf_email: null,
      //       p_onbehalf_district_id: null,
      //       p1man: null,
      //       p1opt: null,
      //       p2man: null,
      //       p2opt: null,
      //       p3man: null,
      //       p3opt: null,
      //       p4man: null,
      //       p4opt: null,
      //       p5man: null,
      //       p5opt: null,
      //       p6man: null,
      //       p7man: null,
      //       p8man: null,
      //       p9man: null,
      //       p10opt: null,
      //       files: []
      //     };

      //     // Populate standard static fields
      //     allParams.p_complainant_name = safeVal(localStorage.getItem('user_name'));
      //     allParams.p_mobile = safeVal(localStorage.getItem('mobile'));
      //     allParams.p_email = safeVal(localStorage.getItem('email'));
      //     allParams.p_district_id = safeVal(localStorage.getItem('district'));
      //     allParams.p_created_by_user_id = safeVal(localStorage.getItem('user_id'));
      //     allParams.p_issue_id = safeVal($('#typeSelect').val());
      //     allParams.p_category_id = safeVal($('#categorySelect').val());
      //     allParams.p_subcategory_id = safeVal($('#subCategorySelect').val());
      //     allParams.p_priority = safeVal($('#priority').val());
      //     allParams.p_description = safeVal($('#description').val());
      //     allParams.p_onbehalf_name = safeVal($('#onbehalf_name').val());
      //     allParams.p_onbehalf_mobile = safeVal($('#onbehalf_mobile').val());
      //     allParams.p_onbehalf_email = safeVal($('#onbehalf_email').val());
      //     allParams.p_onbehalf_district_id = safeVal($('#onbehalf_district_id').val());

      //     // Populate dynamic fields based on relevant columns
      //     columnsArray.forEach(col => {
      //       if (col === "4opt") return; // files handled separately

      //       const field = fieldMap[col];
      //       if (!field) return;

      //       const $input = $(`#dynamicFieldsContainer [data-col="${col}"]`);
      //       if ($input.length) {
      //         allParams[field.paramName] = safeVal($input.val());
      //       }
      //     });

      //     // Add uploaded files if any
      //     if (uploadedFiles.length > 0) {
      //       allParams.files = uploadedFiles;
      //     }

      //     const payload = {
      //       action: "function_call",
      //       function_name: "sp_citizen_create_ticket",
      //       params: allParams
      //     };

      //     console.log("Final Payload:", payload);

      //     // AJAX call
      //     $.ajax({
      //       url: `${BASE_API_URL}/commonfunction`,
      //       method: 'POST',
      //       data: {
      //         data: encryptData(payload)
      //       },
      //       dataType: 'json',
      //       success: function (response) {
      //         console.log("Form submitted successfully:", response);
      //         alert("Submitted successfully.");
      //         setTimeout(() => location.reload(), 1000);
      //       },
      //       error: function (xhr, status, error) {
      //         console.error("API Error:", error);
      //         alert("Failed to submit form.");
      //       }
      //     });

      //   } catch (err) {
      //     console.error("Error in submission:", err);
      //     alert("Something went wrong while preparing the form data.");
      //   }
      // });


      $('#submitBtn').on('click', async function (event) {
        debugger
        event.preventDefault();

        let isValid = true;

        // ✅ Validate declaration checkbox
        if (!$('#declarationCheck').is(':checked')) {
          $('#declarationError').text('You must agree to the declaration.').show();
          isValid = false;
        } else {
          $('#declarationError').hide();
        }

        $('#declarationCheck').on('change', function () {
          if ($(this).is(':checked')) {
            $('#declarationError').hide();
          }
        });

        // ✅ Validate type, category, subcategory
        ['#typeSelect', '#categorySelect', '#subCategorySelect'].forEach(selector => {
          const $el = $(selector);
          if (!$el.val() || $el.val().trim() === '') {
            $el.addClass('is-invalid');
            $el.next('.error-msg').remove();
            $el.after('<span class="error-msg text-danger">This field is required</span>');
            isValid = false;
          } else {
            $el.removeClass('is-invalid');
            $el.next('.error-msg').remove();
          }
        });

        // ✅ Validate mandatory dynamic fields
        $('#dynamicFieldsContainer [data-mandatory="true"]').each(function () {
          if ($(this).val().trim() === '') {
            $(this).addClass('is-invalid');
            $(this).next('.error-msg').remove();
            $(this).after('<span class="error-msg text-danger">This field is required</span>');
            isValid = false;
          } else {
            $(this).removeClass('is-invalid');
            $(this).next('.error-msg').remove();
          }
        });

        if (!isValid) {
          showErrorToast('Please fill in all mandatory fields.');
          return;
        }

        try {
          // ✅ Collect uploaded files
          const uploadedFiles = await processFiles();

          // ✅ Get relevant columns for selected subcategory
          const selectedOption = $('#subCategorySelect').find('option:selected');
          const columnsData = selectedOption.attr('data-columns'); // e.g., "3man,4opt,7man"
          const columnsArray = columnsData ? columnsData.split(',').map(c => c.trim()) : [];

          // ✅ All possible params with default null
          const allParams = {
            p_complainant_name: null,
            p_mobile: null,
            p_email: null,
            p_district_id: 2,
            p_issue_id: null,
            p_created_by_user_id: null,
            p_category_id: null,
            p_subcategory_id: null,
            p_priority: null,
            p_description: null,
            p_onbehalf_name: null,
            p_onbehalf_mobile: null,
            p_onbehalf_email: null,
            p_onbehalf_district_id: null,
            p1man: null, p1opt: null,
            p2man: null, p2opt: null,
            p3man: null, p3opt: null,
            p4man: null, p4opt: null,
            p5man: null, p5opt: null,
            p6man: null,
            p7man: null,
            p8man: null,
            p9man: null,
            p10opt: null,
          };

          // ✅ Populate static fields
          allParams.p_complainant_name = safeVal(localStorage.getItem('user_name'));
          allParams.p_mobile = safeVal(localStorage.getItem('mobile'));
          allParams.p_email = safeVal(localStorage.getItem('email'));
          // allParams.p_district_id = safeVal(localStorage.getItem('district'));
          allParams.p_created_by_user_id = safeVal(localStorage.getItem('user_id'));
          allParams.p_issue_id = safeVal($('#typeSelect').val());
          allParams.p_category_id = safeVal($('#categorySelect').val());
          allParams.p_subcategory_id = safeVal($('#subCategorySelect').val());
          allParams.p_priority = safeVal($('#priority').val());
          allParams.p_description = safeVal($('#description').val());
          allParams.p_onbehalf_name = safeVal($('#onbehalf_name').val());
          allParams.p_onbehalf_mobile = safeVal($('#onbehalf_mobile').val());
          allParams.p_onbehalf_email = safeVal($('#onbehalf_email').val());
          allParams.p_onbehalf_district_id = safeVal($('#onbehalf_district_id').val());

          // ✅ Declaration
          // allParams.p_declaration = $('#declarationCheck').is(':checked') ? "Yes" : "No";

          // ✅ Populate dynamic fields (except files)
          columnsArray.forEach(col => {
            col = col.trim();

            if (col === "4opt" || col === "4man") {
              // handled separately
              return;
            }

            const $input = $(`#dynamicFieldsContainer [data-col="${col}"]`);
            if ($input.length) {
              const paramName = `p${col}`;
              allParams[paramName] = safeVal($input.val());
            }
          });

          // ✅ Bind file params (p4man / p4opt) properly
          uploadedFiles.forEach(fileObj => {
            if (fileObj.mandatory) {
              allParams.p4man = JSON.stringify([fileObj]);
            } else {
              allParams.p4opt = JSON.stringify([fileObj]);
            }
          });

          const payload = {
            action: "function_call",
            function_name: "fn_citizen_create_ticket",
            params: allParams
          };

          console.log("Final Payload:", payload);

          // ✅ Submit via AJAX
          $.ajax({
            url: `${BASE_API_URL}/commonfunction`,
            method: 'POST',
            data: { data: encryptData(payload) },
            dataType: 'json',
            success: function (response) {
              console.log("Form submitted successfully:", response);
              alert("Submitted successfully.");
              setTimeout(() => location.reload(), 1000);
            },
            error: function (xhr, status, error) {
              console.error("API Error:", error);
              alert("Failed to submit form.");
            }
          });

        } catch (err) {
          console.error("Error in submission:", err);
          alert("Something went wrong while preparing the form data.");
        }
      });


    });
  </script>


</body>

</html>