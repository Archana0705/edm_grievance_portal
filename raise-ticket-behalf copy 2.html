<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Citizen behalf Raise Ticket</title>
  <!-- Bootstrap CSS -->

  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/font/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/aos.css" rel="stylesheet">

  <style>
    body {
      background: #f9fafb;
    }

    .card {
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .step-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #444;
    }

    .btn-primary {
      border-radius: 30px;
      padding: 10px 25px;
    }

    .hidden {
      display: none;
    }

    .success-check {
      font-size: 3rem;
      color: green;
      display: none;
      animation: bounceIn 1s forwards;
    }

    @keyframes bounceIn {
      0% {
        transform: scale(0.3);
        opacity: 0;
      }

      50% {
        transform: scale(1.1);
        opacity: 1;
      }

      100% {
        transform: scale(1);
      }
    }
  </style>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f1f3f6;
      color: #333;
    }

    body {
      display: flex;
      flex-direction: column;
      padding-top: 70px;
      transition: all 0.3s;
    }

    /* Header */
    nav.navbar {
      background: linear-gradient(90deg, #4b6cb7, #182848);
      color: #fff;
      z-index: 1000;
      padding: 0.4rem 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    nav.navbar .navbar-brand,
    nav.navbar .btn,
    nav.navbar span {
      color: #fff;
    }

    nav.navbar .btn-light {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: #fff;
    }

    nav.navbar .btn-light:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      width: 220px;
      height: calc(100% - 70px);
      background: #fff;
      padding-top: 1rem;
      transition: all 0.3s;
      overflow-y: auto;
      border-right: 1px solid #e0e0e0;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
      z-index: 999;
    }

    #sidebar a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #495057;
      text-decoration: none;
      font-weight: 500;
      border-radius: 8px;
      margin: 4px 10px;
      transition: all 0.2s ease-in-out;
    }

    #sidebar a:hover {
      background: #4b6cb7;
      color: #fff;
      transform: translateX(5px);
    }

    #sidebar a.active {
      background: #182848;
      color: white;
    }

    #sidebar i {
      margin-right: 12px;
      font-size: 1.2rem;
    }

    .sidebar-collapsed #sidebar a {
      padding: 12px 0px;
    }

    /* Collapsed sidebar */
    body.sidebar-collapsed #sidebar {
      width: 60px;
    }

    body.sidebar-collapsed #sidebar a span {
      display: none;
    }

    body.sidebar-collapsed #sidebar a i {
      margin-right: 0;
      width: 100%;
      text-align: center;
    }

    /* Main content */
    #mainContent {
      margin-left: 220px;
      padding: 30px;
      flex: 1;
      transition: all 0.3s;
    }

    body.sidebar-collapsed #mainContent {
      margin-left: 60px;
    }

    /* Cards for main content */
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* Footer */
    footer {
      background: #fff;
      text-align: center;
      padding: 15px;
      border-top: 1px solid #ddd;
      width: 100%;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Mobile responsiveness */
    @media (max-width: 992px) {
      #sidebar {
        left: -100%;
        top: 0;
        width: 220px;
        height: 100%;
        border-right: none;
        box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
        z-index: 9999;
      }

      #sidebar.show {
        left: 0;
      }

      #mainContent {
        margin-left: 0;
        padding: 20px 10px;
      }

      body.sidebar-collapsed #mainContent {
        margin-left: 0;
      }
    }

    @media (max-width: 768px) {
      #currentDateTime {
        display: none;
      }

      .navbar .fw-bold {
        font-size: 1.1rem;
      }

      #sidebarToggle {
        padding: 0.35rem 0.6rem;
      }

      .dropdown-toggle span {
        display: none;
      }
    }
  </style>
  <style>
    .hover-shadow:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      transition: all 0.3s;
    }

    .card h3 {
      font-weight: 600;
    }

    .card i {
      transition: transform 0.3s;
    }

    .card:hover i {
      transform: scale(1.2);
    }

    .table-hover tbody tr:hover {
      background-color: #f1f3f5;
    }
  </style>
  <!-- main content -->
  <!-- page css -->
  <style>
    body {
      background: #f8f9fa;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .form-section {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .form-label {
      font-weight: 500;
    }

    .btn-submit {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      color: #fff;
      font-weight: 600;
      border-radius: 8px;
      transition: 0.3s;
    }

    .btn-submit:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
  <style>
    /* Toast positioning */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 2000;
    }
  </style>
</head>

<body>


  <!-- Main Content -->
  <div class="card p-4" data-aos="fade-up">

    <div id="step1" class="">
      <div class="form-section">
        <form id="issueForm" class="needs-validation" novalidate>
          <div class="row">
            <div class="mb-3 col-lg-4">
              <label for="relationshipField">Relationship Type <span class="text-danger">*</span></label>
              <select id="relationshipField" class="form-select mb-2">
                <option selected="">Select Relationship Type</option>
                <option>Sister</option>
                <option>Friend</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-3 col-lg-4">
              <label for="citizenName">Citizen Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="citizenName" placeholder="Enter Citizen Name">
            </div>
            <div class="mb-3 col-lg-4">
              <label for="genderField">Gender <span class="text-danger">*</span></label>
              <select id="genderField" class="form-select mb-2">
                <option selected="">Select Gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-3 col-lg-4">
              <label class="form-label">Email</label>
              <input type="email" id="emailField" class="form-control mb-3" placeholder="Enter your Email">
            </div>

            <div class="clear-both"></div>

            <div class="mb-3 col-lg-4">
              <label for="typeSelectBehalf">Type <span class="text-danger">*</span></label>

              <select id="typeSelectBehalf" class="form-control" required>
                <option value="">Select Type</option>
              </select>
            </div>
            <div class="mb-3 col-lg-4">
              <label for="categorySelectBehalf">Category <span class="text-danger">*</span></label>
              <select id="categorySelectBehalf" class="form-control" required>
                <option value="">Select Category</option>
              </select>
            </div>
            <div class="mb-3 col-lg-4">
              <label for="subCategorySelectBehalf">Sub-Category <span class="text-danger">*</span></label>
              <select id="subCategorySelectBehalf" class="form-control" required>
                <option value="">Select Sub-Category</option>
              </select>
            </div>

          </div>
          <!-- Dynamic Form -->
          <div id="dynamicFieldsContainerBehalf" class="mt-4"></div>

          <!-- Declaration Component -->
          <div class="alert alert-light border rounded-3 shadow-sm p-3 mb-4" role="alert">
            <div class="d-flex align-items-start">
              <i class="bi bi-info-circle-fill text-primary fs-4 me-3"></i>
              <div>
                <h6 class="fw-bold mb-2">Declaration</h6>
                <p class="mb-2 small text-muted">
                  I hereby declare that the information provided in this portal is true and correct
                  to the best of my knowledge. Any false information may lead to rejection of the grievance.
                </p>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="declarationCheck">
                  <label class="form-check-label small" for="declarationCheck">
                    I agree to the terms of this declaration
                  </label>
                </div>
                <span class="text-danger small" id="declarationError" style="display:none;"></span>

              </div>
            </div>
          </div>


          <!-- Submit -->
          <div class="col-lg-4 d-flex align-items-center">
            <button type="submit" id="submitBtnBehalf" class="btn btn-primary px-4 py-2">
              <i class="bi bi-send-fill me-2"></i> Submit Issue
            </button>
          </div>
        </form>


      </div>
    </div>
  </div>

  <script>
    // Sidebar toggle

    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');

    sidebarToggle.addEventListener('click', () => {
      if (window.innerWidth < 992) {
        // Mobile: slide in/out
        sidebar.classList.toggle('show');
      } else {
        // Desktop: collapse sidebar
        document.body.classList.toggle('sidebar-collapsed');
      }
    });

    // Close mobile sidebar when clicking outside
    document.addEventListener('click', function (e) {
      if (window.innerWidth < 992) {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
          sidebar.classList.remove('show');
        }
      }
    });

    // Display current date and time
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      document.getElementById('currentDateTime').textContent = now.toLocaleDateString(undefined, options) + ' ' + timeString;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();
  </script>

  <script>
    AOS.init();
    const roleId = localStorage.getItem("role_id");

    // ✅ Relationship dropdown (scoped)
    function loadRelationship() {
      const payload = {
        action: "function_call",
        function_name: "fn_relationship",
        params: {}
      };

      $.ajax({
        url: `${BASE_API_URL}/commonfunction`,
        method: "POST",
        data: { data: encryptData(payload) },
        dataType: 'json',
        success: function (response) {
          const decrypted = decryptData(response.data);
          const $dropdown = $("#behalfPane #relationshipField");
          $dropdown.empty().append('<option value="" class="placeholder">--Select Relationship--</option>');

          decrypted.forEach(item => {
            $dropdown.append(`<option value="${item.relationship}">${item.relationship}</option>`);
          });
        },
        error: function () {
          alert('Failed to load relationship list. Please try again.');
        }
      });
    }
    loadRelationship();

    // ✅ Issue Type
    function loadIssueType() {
      const payload = {
        action: "function_call",
        function_name: "fn_issue_type",
        params: {}
      };

      $.ajax({
        url: `${BASE_API_URL}/commonfunction`,
        method: "POST",
        data: { data: encryptData(payload) },
        dataType: "json",
        success(response) {
          const decrypted = decryptData(response.data);
          const $dropdown = $("#behalfPane #typeSelectBehalf");
          $dropdown.empty().append('<option value="" class="placeholder">--Select Type--</option>');

          decrypted.forEach(item => {
            $dropdown.append(`<option value="${item.id}">${item.issue_name}</option>`);
          });
        }
      });
    }
    loadIssueType();

    // ✅ Category
    $("#behalfPane #typeSelectBehalf").on("change", function () {
      const selectedType = $(this).val();
      const operatorPayload = {
        action: "function_call",
        function_name: "fn_issue_category",
        params: { type: selectedType || '', roleid: roleId }
      };

      $.ajax({
        url: `${BASE_API_URL}/commonfunction`,
        method: 'POST',
        data: { data: encryptData(operatorPayload) },
        dataType: 'json',
        success(response) {
          const decrypted = decryptData(response.data);
          const $dropdown = $("#behalfPane #categorySelectBehalf");
          $dropdown.empty().append('<option value="" class="placeholder">--Select Category--</option>');

          decrypted.forEach(item => {
            $dropdown.append(`<option value="${item.id}">${item.issue_name}</option>`);
          });
        }
      });
    });

    // ✅ Sub Category + dynamic fields
    $("#behalfPane #categorySelectBehalf").on("change", function () {
      const selectedCategory = $(this).val();
      const operatorPayload = {
        action: "function_call",
        function_name: "fn_issue_subcategory",
        params: { type: selectedCategory || '', roleid: roleId }
      };

      $.ajax({
        url: `${BASE_API_URL}/commonfunction`,
        method: 'POST',
        data: { data: encryptData(operatorPayload) },
        dataType: 'json',
        success(response) {
          const decrypted = decryptData(response.data);
          const $dropdown = $("#behalfPane #subCategorySelectBehalf");
          $dropdown.empty().append('<option value="" class="placeholder">--Select Sub Category--</option>');

          decrypted.forEach(item => {
            $dropdown.append(`<option value="${item.id}" data-columns="${item.relavant_columns || ''}">${item.issue_name}</option>`);
          });

          // Clear old dynamic fields
          $("#behalfPane #dynamicFieldsContainerBehalf").empty();
        }
      });
    });

    const fieldMapBehalf = {
      "1man": { label: "CAN Number", type: "text", required: true },
      "1opt": { label: "CAN Number", type: "text", required: false },
      "2man": { label: "Application number", type: "text", required: true },
      "2opt": { label: "Application number", type: "text", required: false },
      "3man": { label: "Description of changes and reason", type: "textarea", required: true },
      "3opt": { label: "Description of the issue", type: "textarea", required: false },
      "4man": { label: "Attachments", type: "file", required: true, multiple: true },
      "4opt": { label: "Attachments", type: "file", required: false, multiple: true },
      "5man": { label: "Supporting document description", type: "textarea", required: true },
      // "5opt": { label: "Supporting document description", type: "textarea", required: false },
      "6man": { label: "Enter eSevai log in ID", type: "text", required: true },
      "7man": { label: "Enter eSevai centre ID", type: "text", required: true },
      "8man": { label: "Transaction number", type: "text", required: true },
      "9man": { label: "Enter reason for ID block", type: "textarea", required: true },
      "10opt": { label: "Enter name of official", type: "text", required: false }
    };

    $("#behalfPane #subCategorySelectBehalf").on("change", function () {
      const selectedOption = $(this).find("option:selected");
      const columnsData = selectedOption.attr("data-columns");
      generateDynamicFieldsBehalf(columnsData);
    });

    function generateDynamicFieldsBehalf(columnsStringBehalf) {
      const $container = $("#behalfPane #dynamicFieldsContainerBehalf");
      $container.empty();

      if (!columnsStringBehalf) {
        $container.append('<p>No additional fields required.</p>');
        return;
      }

      const columnsArrayBehalf = columnsStringBehalf.split(",");
      columnsArrayBehalf.forEach((col, index) => {
        col = col.trim();
        const field = fieldMapBehalf[col];
        if (!field) return;

        const inputIdBehalf = `field_${col}_${index}`;
        const isMandatoryBehalf = col.endsWith("man");
        const mandatoryAttrBehalf = isMandatoryBehalf ? 'data-mandatory="true"' : '';
        const dataColAttrBehalf = `data-col="${col}"`;

        if (col === "4opt" || col === "4man") {
          const wrapperId = `wrapper_${inputIdBehalf}`;
          const html = `
          <div id="${wrapperId}" class="mb-3 file-wrapper" ${dataColAttrBehalf} ${mandatoryAttrBehalf}>
            <label class="form-label">${field.label}${isMandatoryBehalf ? ' <span class="text-danger">*</span>' : ''}</label>

            <div class="row fw-bold border-bottom pb-2 mb-2">
              <div class="col-md-1">S No</div>
              <div class="col-md-4">Attachment Description</div>
              <div class="col-md-4">Attachment <small class="text-muted text-danger">(max 2MB each)</small></div>
              <div class="col-md-3">Actions</div>
            </div>

            <div class="file-rows">
              <div class="file-row row align-items-center mb-2">
                <div class="col-md-1">
                  <span class="fw-bold file-label">1</span>
                </div>
                <div class="col-md-4">
                  <input type="text" maxlength="250" class="form-control file-desc" placeholder="Enter document description">
                </div>
                <div class="col-md-4">
                  <input type="file" class="form-control ${fileInputClass}">
                </div>
                <div class="col-md-3">
                  <button type="button" class="btn btn-danger btn-sm btn-delete-file">Delete</button>
                </div>
              </div>
            </div>

            <div class="mt-2">
              <button type="button" class="btn btn-primary btn-sm btn-add-file">Add More</button>
            </div>
          </div>
        `;
          $container.append(html);
        } else {

          let fieldHtml = "";
          if (field.type === "textarea") {
            fieldHtml = `
        <div class="mb-3">
          <label for="${inputIdBehalf}">${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}</label>
          <textarea id="${inputIdBehalf}" class="form-control" ${dataColAttrBehalf} ${mandatoryAttrBehalf}></textarea>
        </div>`;
          } else if (field.type === "file") {
            fieldHtml = `
        <div class="mb-3">
          <label for="${inputIdBehalf}">${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}</label>
          <input id="${inputIdBehalf}" type="file" class="form-control file-input-behalf" ${dataColAttrBehalf} ${mandatoryAttrBehalf}>
        </div>`;
          } else {
            fieldHtml = `
        <div class="mb-3">
          <label for="${inputIdBehalf}">${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}</label>
          <input id="${inputIdBehalf}" type="${field.type}" class="form-control" ${dataColAttrBehalf} ${mandatoryAttrBehalf}>
        </div>`;
          }
          $container.append(fieldHtml);
        }
      });
    }

    // ✅ Validation fix
    $("#behalfPane #submitBtnBehalf").on("click", async function (event) {
      debugger
      event.preventDefault();
      let isValidBehalf = true;

      // validate mandatory fields
      const requiredSelectors = [
        "#relationshipField",
        "#citizenName",
        "#genderField",
        "#typeSelectBehalf",
        "#categorySelectBehalf",
        "#subCategorySelectBehalf"
      ];

      requiredSelectors.forEach(sel => {
        const $el = $(`#behalfPane ${sel}`);
        if (!$el.val() || $el.val().trim() === "") {
          $el.addClass("is-invalid");
          $el.next(".error-msg").remove();
          $el.after('<span class="error-msg text-danger">This field is required</span>');
          isValidBehalf = false;
        } else {
          $el.removeClass("is-invalid");
          $el.next(".error-msg").remove();
        }
      });

      if (!isValidBehalf) {
        showErrorToast("Please fill in all mandatory fields.");
        return;
      }

      function safeVal(val) {
        if (val === undefined || val === null) return null;
        if (typeof val === "string" && val.trim() === "") return null;
        return val;
      }
      try {
        var user_id = localStorage.getItem('user_id');

        // ✅ Get relevant columns for selected subcategory
        const selectedOption = $('#subCategorySelectBehalf').find('option:selected');
        const columnsData = selectedOption.attr('data-columns'); // e.g., "3man,4opt,7man"
        const columnsArrayBehalf = columnsData ? columnsData.split(',').map(c => c.trim()) : [];

        // ✅ All possible params with default null
        const allParams = {
          p_session_id: user_id,
          p_complainant_name: null,
          p_mobile: null,
          p_email: null,
          p_district_id: null,
          p_issue_id: null,
          p_created_by: null,
          p_category_id: null,
          p_subcategory_id: null,
          p_priority: null,
          p_relationship: null,
          p_description: null,
          p_onbehalf_name: null,
          p_onbehalf_mobile: null,
          p_onbehalf_email: null,
          p_onbehalf_district_id: null,
          p1man: null, p1opt: null,
          p2man: null, p2opt: null,
          p3man: null, p3opt: null,
          // p4man: null, p4opt: null,
          p5man: null, p5opt: null,
          p6man: null,
          p7man: null,
          p8man: null,
          p9man: null,
          p10opt: null,
        };

        // ✅ Populate static fields
        allParams.p_complainant_name = safeVal(localStorage.getItem('user_name'));
        allParams.p_mobile = safeVal(localStorage.getItem('mobile'));
        allParams.p_email = safeVal(localStorage.getItem('email'));
        // allParams.p_district_id = safeVal(localStorage.getItem('district'));
        allParams.p_created_by = safeVal(localStorage.getItem('user_id'));
        allParams.p_issue_id = safeVal($('#typeSelectBehalf').val());
        allParams.p_category_id = safeVal($('#categorySelectBehalf').val());
        allParams.p_subcategory_id = safeVal($('#subCategorySelectBehalf').val());
        allParams.p_priority = safeVal($('#priority').val());
        allParams.p_relationship = safeVal($('#relationshipField').val());
        allParams.p_description = safeVal($('#description').val());
        allParams.p_onbehalf_name = safeVal($('#citizenName').val());
        allParams.p_onbehalf_mobile = safeVal($('#citizenMobile').val());
        allParams.p_onbehalf_email = safeVal($('#emailField').val());
        allParams.p_onbehalf_district_id = safeVal($('#districtField').val());

        // ✅ Declaration
        // allParams.p_declaration = $('#declarationCheck').is(':checked') ? "Yes" : "No";

        // ✅ Populate dynamic fields (except files)
        columnsArrayBehalf.forEach(col => {
          col = col.trim();

          if (col === "4opt" || col === "4man") {
            // handled separately
            return;
          }

          const $input = $(`#dynamicFieldsContainerBehalf [data-col="${col}"]`);
          if ($input.length) {
            const paramName = `p${col}`;
            allParams[paramName] = safeVal($input.val());
          }
        });

        const payload = {
          action: "function_call",
          function_name: "fn_citizen_create_ticket",
          params: allParams
        };

        console.log("Final Payload:", payload);

        // ✅ Submit via AJAX
        $.ajax({
          url: `${BASE_API_URL}/commonfunction`,
          method: 'POST',
          data: { data: encryptData(payload) },
          dataType: 'json',
          success: function (response) {
            console.log("Form submitted successfully:", response);
            alert("Submitted successfully.");
            setTimeout(() => location.reload(), 1000);
          },
          error: function (xhr, status, error) {
            console.error("API Error:", error);
            alert("Failed to submit form.");
          }
        });

      } catch (err) {
        console.error("Error in submission:", err);
        alert("Something went wrong while preparing the form data.");
      }
    });
  </script>







</body>

</html>