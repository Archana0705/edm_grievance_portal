<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Dashboard</title>
  <!-- Bootstrap CSS -->

  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/font/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/aos.css" rel="stylesheet">

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f1f3f6;
      color: #333;
    }

    body {
      display: flex;
      flex-direction: column;
      padding-top: 70px;
      transition: all 0.3s;
    }

    /* Header */
    nav.navbar {
      background: linear-gradient(90deg, #4b6cb7, #182848);
      color: #fff;
      z-index: 1000;
      padding: 0.4rem 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    nav.navbar .navbar-brand,
    nav.navbar .btn,
    nav.navbar span {
      color: #fff;
    }

    nav.navbar .btn-light {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: #fff;
    }

    nav.navbar .btn-light:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      width: 220px;
      height: calc(100% - 70px);
      background: #fff;
      padding-top: 1rem;
      transition: all 0.3s;
      overflow-y: auto;
      border-right: 1px solid #e0e0e0;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
      z-index: 999;
    }

    #sidebar a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #495057;
      text-decoration: none;
      font-weight: 500;
      border-radius: 8px;
      margin: 4px 10px;
      transition: all 0.2s ease-in-out;
    }

    #sidebar a:hover {
      background: #4b6cb7;
      color: #fff;
      transform: translateX(5px);
    }

    #sidebar a.active {
      background: #182848;
      color: white;
    }

    #sidebar i {
      margin-right: 12px;
      font-size: 1.2rem;
    }

    .sidebar-collapsed #sidebar a {
      padding: 12px 0px;
    }

    /* Collapsed sidebar */
    body.sidebar-collapsed #sidebar {
      width: 60px;
    }

    body.sidebar-collapsed #sidebar a span {
      display: none;
    }

    body.sidebar-collapsed #sidebar a i {
      margin-right: 0;
      width: 100%;
      text-align: center;
    }

    /* Main content */
    #mainContent {
      margin-left: 220px;
      padding: 30px;
      flex: 1;
      transition: all 0.3s;
    }

    body.sidebar-collapsed #mainContent {
      margin-left: 60px;
    }

    /* Cards for main content */
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* Footer */
    footer {
      background: #fff;
      text-align: center;
      padding: 15px;
      border-top: 1px solid #ddd;
      width: 100%;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Mobile responsiveness */
    @media (max-width: 992px) {
      #sidebar {
        left: -100%;
        top: 0;
        width: 220px;
        height: 100%;
        border-right: none;
        box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
        z-index: 9999;
      }

      #sidebar.show {
        left: 0;
      }

      #mainContent {
        margin-left: 0;
        padding: 20px 10px;
      }

      body.sidebar-collapsed #mainContent {
        margin-left: 0;
      }
    }

    @media (max-width: 768px) {
      #currentDateTime {
        display: none;
      }

      .navbar .fw-bold {
        font-size: 1.1rem;
      }

      #sidebarToggle {
        padding: 0.35rem 0.6rem;
      }

      .dropdown-toggle span {
        display: none;
      }
    }
  </style>
  <!-- main content -->
  <style>
    .hover-shadow:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      transition: all 0.3s;
    }

    .card h3 {
      font-weight: 600;
    }

    .card i {
      transition: transform 0.3s;
    }

    .card:hover i {
      transform: scale(1.2);
    }

    .table-hover tbody tr:hover {
      background-color: #f1f3f5;
    }
  </style>
  <!-- main content -->
  <!-- page css -->
  <style>
    body {
      background: #f8f9fa;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .form-section {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .form-label {
      font-weight: 500;
    }

    .btn-submit {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      color: #fff;
      font-weight: 600;
      border-radius: 8px;
      transition: 0.3s;
    }

    .btn-submit:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
  <style>
    /* Toast positioning */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 2000;
    }
  </style>
  <!-- page css -->
</head>

<body>
  <!-- Main Content -->
  <div class="form-section">
    <!-- Main Form -->
    <form id="issueForm" class="needs-validation" novalidate enctype="multipart/form-data">
      <div class="row g-3">
        <!-- Dropdowns -->
        <div class="mb-3 col-lg-4">
          <label for="typeSelect">Type <span class="text-danger">*</span></label>
          <select id="typeSelect" class="form-control" required>
            <option value="">Select Type</option>
          </select>
        </div>

        <div class="mb-3 col-lg-4">
          <label for="categorySelect">Category <span class="text-danger">*</span></label>
          <select id="categorySelect" class="form-control" required>
            <option value="">Select Category</option>
          </select>
        </div>

        <div class="mb-3 col-lg-4">
          <label for="subCategorySelect">Sub-Category <span class="text-danger">*</span></label>
          <select id="subCategorySelect" class="form-control" required>
            <option value="">Select Sub-Category</option>
          </select>
        </div>

      </div>
      <!-- Dynamic Form -->

      <div id="dynamicFieldsContainer" class="mt-4"></div>

      <!-- Declaration Component -->
      <div class="alert alert-light border rounded-3 shadow-sm p-3 mb-4" role="alert">
        <div class="d-flex align-items-start">
          <i class="bi bi-info-circle-fill text-primary fs-4 me-3"></i>
          <div>
            <h6 class="fw-bold mb-2">Declaration</h6>
            <p class="mb-2 small text-muted">
              I hereby declare that the information given above and in the enclosed documents is true to the best of
              my knowledge and belief and nothing has been concealed therein. I understand that if the information
              given by me is proved false/not true, I will have to face the punishment as per the law. Also, all the
              benefits availed by me shall be summarily withdrawn.
            </p>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="declarationCheck">
              <label class="form-check-label small" for="declarationCheck">
                I agree to the terms of this declaration
              </label>
            </div>
            <span class="text-danger small" id="declarationError" style="display:none;"></span>

          </div>
        </div>
      </div>
      <div class="col-lg-4 d-flex align-items-center mt-2">
        <button type="submit" id="submitBtn" class="btn btn-primary px-4 py-2">
          <i class="bi bi-send-fill me-2"></i> Submit Issue
        </button>
      </div>
    </form>

  </div>


  <!-- Bootstrap JS -->

  <!-- <script src="assets/js/jquery-3.7.1.min.js"></script>
  <script src="assets/js/aos.js"></script>
  <script src="assets/js/dataTableUtil.js"></script>
  <script src="assets/js/crypto-js.min.js"></script>
  <script src="assets/js/global.js"></script>
  <script src="assets/js/encrypt_decrypt.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/toastUtil.js"></script>
  <script src="assets/js/apiConfig.js"></script>
  <script src="assets/js/globalProfileDropdown.js"></script> -->



  <script>
    $(document).ready(function () {
      const roleId = localStorage.getItem("role_id") || null;

      // common field map (unchanged)
      const fieldMap = {
        "1man": { label: "CAN Number", type: "text", required: true },
        "1opt": { label: "CAN Number", type: "text", required: false },
        "2man": { label: "Application number", type: "text", required: true },
        "2opt": { label: "Application number", type: "text", required: false },
        "3man": { label: "Description of changes and reason", type: "textarea", required: true },
        "3opt": { label: "Description of the issue", type: "textarea", required: false },
        "4man": { label: "Attachments(Maximum 3 attachments allowed)", type: "file", required: true, multiple: true },
        "4opt": { label: "Attachments(Maximum 3 attachments allowed)", type: "file", required: false, multiple: true },
        // "5man": { label: "Supporting document description (short text)", type: "textarea", required: true },
        // "5opt": { label: "Multiple Supporting document description (short text)", type: "textarea", required: false },
        "6man": { label: "Enter eSevai log in ID", type: "text", required: true },
        "7man": { label: "Enter eSevai centre ID against whom the grievance is lodged", type: "text", required: true },
        "8man": { label: "Transaction number", type: "text", required: true },
        "9man": { label: "Enter reason for ID block", type: "textarea", required: true },
        "10opt": { label: "Enter name of official", type: "text", required: false }
      };

      // Helper: safeVal as you had it
      function safeVal(val) {
        if (val === undefined || val === null) return null;
        if (typeof val === "string" && val.trim() === "") return null;
        return val;
      }

      // Helper: generate dynamic fields (prefix ensures unique IDs)
      function generateDynamicFields(columnsString, prefix, $container, fileInputClass) {
        debugger
        $container.empty();

        if (!columnsString) {
          $container.append('<p>No additional fields required for this subcategory.</p>');
          return;
        }

        const columnsArray = columnsString.split(',');

        columnsArray.forEach((colRaw, index) => {
          const col = colRaw.trim();
          const field = fieldMap[col];
          if (!field) return;

          const inputId = `field_${prefix}_${col}_${index}`;
          const isMandatory = col.endsWith('man');
          const mandatoryAttr = isMandatory ? 'data-mandatory="true"' : '';
          const dataColAttr = `data-col="${col}"`;

          // file wrapper (we store data-col on wrapper to detect mandatory)
          if (col === "4opt" || col === "4man") {
            const wrapperId = `wrapper_${inputId}`;
            const html = `
          <div id="${wrapperId}" class="mb-3 file-wrapper" ${dataColAttr}>
            <label class="form-label">${field.label}${isMandatory ? ' <span class="text-danger">*</span>' : ''}</label>

            <div class="row fw-bold border-bottom pb-2 mb-2">
              <div class="col-md-1">S No</div>
              <div class="col-md-4">Attachment Description</div>
              <div class="col-md-4">Attachment <small class="text-muted text-danger">(max 2MB each)</small></div>
              <div class="col-md-3">Actions</div>
            </div>

            <div class="file-rows">
              <div class="file-row row align-items-center mb-2">
                <div class="col-md-1">
                  <span class="fw-bold file-label">1</span>
                </div>
                <div class="col-md-4">
                  <input type="text" maxlength="250" class="form-control file-desc" placeholder="Enter document description">
                </div>
                <div class="col-md-4">
                  <input type="file" class="form-control ${fileInputClass}">
                </div>
                <div class="col-md-3">
                  <button type="button" class="btn btn-danger btn-sm btn-delete-file">Delete</button>
                </div>
              </div>
            </div>

            <div class="mt-2">
              <button type="button" class="btn btn-primary btn-sm btn-add-file">Add More</button>
            </div>
          </div>
        `;
            $container.append(html);
          } else {
            // normal fields
            let fieldHtml = '';
            if (field.type === "textarea") {
              fieldHtml = `
            <div class="mb-3">
              <label for="${inputId}">
                ${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}
              </label>
              <textarea id="${inputId}" class="form-control" ${dataColAttr} ${mandatoryAttr}></textarea>
            </div>`;
            } else {
              fieldHtml = `
            <div class="mb-3">
              <label for="${inputId}">
                ${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}
              </label>
              <input id="${inputId}" type="${field.type}" class="form-control" ${dataColAttr} ${mandatoryAttr}>
            </div>`;
            }
            $container.append(fieldHtml);
          }
        });
      }

      async function processFilesInContainer($container, fileInputClass) {
        const filesArray = [];
        const manDescArray = []; // will go to p5man
        const optDescArray = []; // will go to p5opt

        $container.find('.file-row').each(function () {
          const $row = $(this);
          const inputEl = $row.find(`input[type="file"].${fileInputClass}`)[0];
          if (!inputEl || !inputEl.files || inputEl.files.length === 0) return;

          const desc = $row.find('.file-desc').val() || '';
          const $wrapper = $row.closest('.file-wrapper');
          const dataCol = $wrapper ? ($wrapper.attr('data-col') || '') : '';
          const mandatory = String(dataCol).endsWith('man');

          for (let i = 0; i < inputEl.files.length; i++) {
            const f = inputEl.files[i];
            filesArray.push({
              file_name: f.name,
              file_path: `/uploads/${f.name}`,
              mime_type: f.type,
              attachment_desc: desc,
              mandatory: mandatory
            });
          }

          // push description into respective arrays
          if (mandatory) manDescArray.push(desc);
          else optDescArray.push(desc);
        });

        return { filesArray, manDescArray, optDescArray };
      }

      // Unified pane initializer
      function initPane(opts) {
        const prefix = opts.prefix;
        const $type = $(opts.typeSelector);
        const $category = $(opts.categorySelector);
        const $subCat = $(opts.subCatSelector);
        const $dyn = $(opts.dynamicContainerSelector);
        const fileInputClass = opts.fileInputClass;
        const $submitBtn = $(opts.submitBtnSelector);

        // Load issue types into the pane's type select
        function loadIssueType() {
          const payload = {
            action: "function_call",
            function_name: "fn_issue_type",
            params: {}
          };
          $.ajax({
            url: `${BASE_API_URL}/commonfunction`,
            method: "POST",
            data: { data: encryptData(payload) },
            dataType: "json",
            success(response) {
              const decrypted = decryptData(response.data);
              $type.empty().append('<option value="" class="placeholder">--Select Type--</option>');
              decrypted.forEach(item => {
                $type.append(`<option value="${item.id}">${item.issue_name}</option>`);
              });
            },
            error() {
              console.warn("Failed to load issue types for", prefix);
            }
          });
        }

        loadIssueType();

        // category depends on type
        $type.on('change', function () {
          const selectedType = $(this).val();
          const operatorPayload = {
            action: "function_call",
            function_name: "fn_issue_category",
            params: { type: selectedType || '', roleid: roleId }
          };
          $.ajax({
            url: `${BASE_API_URL}/commonfunction`,
            method: 'POST',
            data: { data: encryptData(operatorPayload) },
            dataType: 'json',
            success(response) {
              const decrypted = decryptData(response.data);
              $category.empty().append('<option value="" class="placeholder">--Select Category--</option>');
              decrypted.forEach(item => {
                $category.append(`<option value="${item.id}">${item.issue_name}</option>`);
              });
            },
            error() {
              console.warn("Failed to load categories for", prefix);
            }
          });
        });

        // subcategory depends on category
        $category.on('change', function () {
          const selectedCategory = $(this).val();
          const operatorPayload = {
            action: "function_call",
            function_name: "fn_issue_subcategory",
            params: { type: selectedCategory || '', roleid: roleId }
          };
          $.ajax({
            url: `${BASE_API_URL}/commonfunction`,
            method: 'POST',
            data: { data: encryptData(operatorPayload) },
            dataType: 'json',
            success(response) {
              const decrypted = decryptData(response.data);
              $subCat.empty().append('<option value="" class="placeholder">--Select Sub Category--</option>');
              decrypted.forEach(item => {
                // store columns in attribute
                $subCat.append(`<option value="${item.id}" data-columns="${item.relavant_columns || ''}">${item.issue_name}</option>`);
              });
              // clear previous dynamic fields
              $dyn.empty();
            },
            error() {
              console.warn("Failed to load subcategories for", prefix);
            }
          });
        });

        // when subcategory chosen -> build dynamic fields
        $subCat.on('change', function () {
          const selectedOption = $(this).find('option:selected');
          const columnsData = selectedOption.attr('data-columns') || '';
          generateDynamicFields(columnsData, prefix, $dyn, fileInputClass);
        });

        // Container-scoped: add more file row
        $dyn.on('click', '.btn-add-file', function () {
          const $wrapper = $(this).closest(".file-wrapper");
          const $rowsContainer = $wrapper.find(".file-rows");
          const rowCount = $rowsContainer.find(".file-row").length + 1;
          if (rowCount >= 4) {
            showErrorToast("Maximum 3 attachments allowed.");
            return;
          }
          const newRow = `
        <div class="file-row row align-items-center mb-2">
          <div class="col-md-1">
            <span class="fw-bold file-label">${rowCount}</span>
          </div>
          <div class="col-md-4">
            <input type="text" maxlength="250" class="form-control file-desc" placeholder="Enter document description">
          </div>
          <div class="col-md-4">
            <input type="file" class="form-control ${fileInputClass}">
          </div>
          <div class="col-md-3">
            <button type="button" class="btn btn-danger btn-sm btn-delete-file">Delete</button>
          </div>
        </div>
      `;
          $rowsContainer.append(newRow);
        });

        // Container-scoped: delete file row and renumber
        $dyn.on('click', '.btn-delete-file', function () {
          const $wrapper = $(this).closest(".file-wrapper");
          $(this).closest(".file-row").remove();
          $wrapper.find(".file-row").each(function (i) {
            $(this).find(".file-label").text(i + 1);
          });
        });

        // Container-scoped: file change -> upload only that file (AJAX)
        $dyn.on('change', `input[type="file"].${fileInputClass}`, function () {
          const file = this.files[0];
          if (!file) return;

          const allowedTypes = ["application/pdf", "image/jpeg", "image/png", "image/jpg"];
          const maxSize = 2 * 1024 * 1024;

          if (!allowedTypes.includes(file.type)) {
            showErrorToast("Invalid file type! Only PDF, JPEG, and PNG files are allowed.");
            $(this).val("");
            return;
          }
          if (file.size > maxSize) {
            showErrorToast("File size exceeds 2MB limit!");
            $(this).val("");
            return;
          }

          const sessionId = localStorage.getItem("session_id") || "session_id_00000";
          const userId = localStorage.getItem("user_id");

          const tempPayload = {
            action: "function_call",
            function_name: "fn_temp_ticket_attachments",
            params: {
              p_session_id: sessionId,
              p_file_name: file.name,
              p_file_path: `/uploads/${file.name}`,
              p_mime_type: file.type,
              p_uploaded_by: userId
            }
          };

          const formData = new FormData();
          formData.append("data", encryptData(tempPayload));
          formData.append("file", file);

          // Use dataType json and show server message if any
          $.ajax({
            url: `${BASE_API_URL}/commonfunction`,
            method: "POST",
            data: formData,
            contentType: false,
            processData: false,
            dataType: 'json',
            success: function (response) {
              // prefer server-provided message if present
              const serverMsg = (response && response.message) ? response.message : "File uploaded successfully!";
              console.log("serverMsg:", serverMsg);
              showSuccessToast("File uploaded successfully!", serverMsg);
            },
            error: function (xhr, status, error) {
              console.error("Upload failed:", error);
              showErrorToast("File upload failed!");
            }
          });
        });

        // Container-scoped input validation helpers
        $dyn.on('input change', 'input, textarea, select', function () {
          const $this = $(this);
          if ($this.data('mandatory') && $this.val().trim() === '') {
            $this.addClass('is-invalid');
            $this.next('.error-msg').remove();
            $this.after('<span class="error-msg text-danger">This field is required</span>');
          } else {
            $this.removeClass('is-invalid');
            $this.next('.error-msg').remove();
          }
        });

        // Non-dynamic mandatory selects (type/category/subcategory) - container independent
        $type.add($category).add($subCat).on('change', function () {
          const $el = $(this);
          if ($el.val() && $el.val().trim() !== '') {
            $el.removeClass('is-invalid');
            $el.next('.error-msg').remove();
          }
        });

        // Submit handler for this pane
        $submitBtn.on('click', async function (event) {
          event.preventDefault();
          let isValid = true;

          // declaration checkbox (same id across panes in your HTML — if different, adjust)
          if (!$('#declarationCheck').is(':checked')) {
            $('#declarationError').text('You must agree to the declaration.').show();
            isValid = false;
          } else {
            $('#declarationError').hide();
          }

          // Validate main selects
          [$type, $category, $subCat].forEach($el => {
            if (!$el.val() || $el.val().trim() === '') {
              $el.addClass('is-invalid');
              $el.next('.error-msg').remove();
              $el.after('<span class="error-msg text-danger">This field is required</span>');
              isValid = false;
            } else {
              $el.removeClass('is-invalid');
              $el.next('.error-msg').remove();
            }
          });

          // Validate mandatory dynamic fields inside this pane
          $dyn.find('[data-mandatory="true"]').each(function () {
            if ($(this).val().trim() === '') {
              $(this).addClass('is-invalid');
              $(this).next('.error-msg').remove();
              $(this).after('<span class="error-msg text-danger">This field is required</span>');
              isValid = false;
            } else {
              $(this).removeClass('is-invalid');
              $(this).next('.error-msg').remove();
            }
          });

          if (!isValid) {
            showErrorToast('Please fill in all mandatory fields.');
            return;
          }

          try {
            // collect uploaded files info (not the file binary — server already stored them on each file change)
            const { filesArray: uploadedFiles, manDescArray, optDescArray } = await processFilesInContainer($dyn, fileInputClass);

            // get selected option columns
            const selectedOption = $subCat.find('option:selected');
            const columnsData = selectedOption.attr('data-columns') || '';
            const columnsArray = columnsData ? columnsData.split(',').map(c => c.trim()) : [];

            // prepare params with defaults
            const allParams = {
              p_session_id: 1,
              p_complainant_name: null,
              p_mobile: null,
              p_email: null,
              p_district_id: null,
              p_issue_id: null,
              p_created_by: null,
              p_category_id: null,
              p_subcategory_id: null,
              p_priority: null,
              p_relationship: null,
              p_onbehalf_name: null,
              p_onbehalf_mobile: null,
              p_onbehalf_email: null,
              p_onbehalf_district_id: null,
              p1man: null, p1opt: null,
              p2man: null, p2opt: null,
              p3man: null, p3opt: null,
              p5man: null, p5opt: null,
              p6man: null,
              p7man: null,
              p8man: null,
              p9man: null,
              p10opt: null,
              // p4man/p4opt handled below
            };

            // static fields (shared)
            allParams.p_complainant_name = safeVal(localStorage.getItem('user_name'));
            allParams.p_mobile = safeVal(localStorage.getItem('mobile'));
            allParams.p_email = safeVal(localStorage.getItem('email'));
            allParams.p_district_id = safeVal(localStorage.getItem('district_id'));
            allParams.p_created_by = safeVal(localStorage.getItem('user_id'));
            allParams.p_issue_id = safeVal($type.val());
            allParams.p_category_id = safeVal($category.val());
            allParams.p_subcategory_id = safeVal($subCat.val());
            allParams.p_priority = safeVal($('#priority').val());
            // allParams.p_description = safeVal($('#description').val());

            // optional behalf-specific fields — keep your existing selectors (they may not exist for self pane)
            if (prefix === 'behalf') {
              allParams.p_onbehalf_name = safeVal($('#citizenName').val());
              allParams.p_onbehalf_mobile = safeVal($('#citizenMobile').val());
              allParams.p_onbehalf_email = safeVal($('#emailField').val());
              allParams.p_onbehalf_district_id = safeVal($('#districtField').val());
            } else {
              allParams.p_onbehalf_name = safeVal($('#onbehalf_name').val());
              allParams.p_onbehalf_mobile = safeVal($('#onbehalf_mobile').val());
              allParams.p_onbehalf_email = safeVal($('#onbehalf_email').val());
              allParams.p_onbehalf_district_id = safeVal($('#onbehalf_district_id').val());
            }

            // populate dynamic non-file fields
            // columnsArray.forEach(col => {
            //   col = col.trim();
            //   if (col === "4opt" || col === "4man") return; // file handled separately
            //   const $input = $dyn.find(`[data-col="${col}"]`);
            //   if ($input.length) {
            //     const paramName = `p${col}`;
            //     allParams[paramName] = safeVal($input.val());
            //   }
            // });


            // allParams.p4man = uploadedFiles.filter(f => f.mandatory).length ? JSON.stringify(uploadedFiles.filter(f => f.mandatory)) : null;
            // allParams.p4opt = uploadedFiles.filter(f => !f.mandatory).length ? JSON.stringify(uploadedFiles.filter(f => !f.mandatory)) : null;

            // attach descriptions into p5man / p5opt
            allParams.p5man = manDescArray.length ? JSON.stringify(manDescArray) : null;
            allParams.p5opt = optDescArray.length ? JSON.stringify(optDescArray) : null;

            const payload = {
              action: "function_call",
              function_name: "fn_citizen_create_ticket",
              params: allParams
            };

            // final submit
            $.ajax({
              url: `${BASE_API_URL}/commonfunction`,
              method: 'POST',
              data: { data: encryptData(payload) },
              dataType: 'json',
              success: function (response) {
                // prefer server message if any
                const msg = (response && response.message) ? response.message : "Submitted successfully.";
                console.log("Submission response:", response);
                showSuccessToast("Submitted successfully.");
                setTimeout(() => location.reload(), 1000);
              },
              error: function (xhr, status, error) {
                console.error("API Error:", error);
                showErrorToast("Failed to submit form.");
              }
            });

          } catch (err) {
            console.error("Error in submission:", err);
            showErrorToast("Something went wrong while preparing the form data.");
          }
        });

      } // end initPane


      // Initialize both panes
      initPane({
        prefix: 'self',
        typeSelector: '#typeSelect',
        categorySelector: '#categorySelect',
        subCatSelector: '#subCategorySelect',
        dynamicContainerSelector: '#dynamicFieldsContainer',
        fileInputClass: 'file-input-self',
        submitBtnSelector: '#submitBtn'
      });

    }); // doc ready
  </script>





</body>

</html>